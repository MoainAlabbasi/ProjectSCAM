# ๐ AUTH_FLOW - ุชุฏูู ุงููุตุงุฏูุฉ ูุงูุชูุนูู

> **โ๏ธ ุชุนูููุงุช:** ูุฐุง ุงููุณุชูุฏ ูู ุงููุฑุฌุน ุงูุฑุณูู ูุชุฏูู ุนูููุฉ ุงููุตุงุฏูุฉ ูุงูุชูุนูู ูู ูุธุงู S-ACM. ููู ูุตู ุจุงูุชูุตูู ุงูุฎุทูุงุช ุงูุชู ููุฑ ุจูุง ุงููุณุชุฎุฏู ูู ูููู ุญุณุงุจุงู ุบูุฑ ููุนูู ุฅูู ุฃู ูุตุจุญ ูุณุชุฎุฏูุงู ูุดุทุงู ุฏุงุฎู ุงููุธุงู.

---

## 1. ูุธุฑุฉ ุนุงูุฉ ุนูู ุงูุชุฏูู

ูุนุชูุฏ ุงููุธุงู ุนูู ูููุฐุฌ **"ุงูุฅุถุงูุฉ ุงููุณุจูุฉ ูุน ุงูุชูุนูู ุงูุฐุงุชู" (Pre-provisioning with Self-Activation)**. ูุฐุง ุงููููุฐุฌ ูุฌูุน ุจูู ุงูุฃูุงู ุงูุนุงูู (ุญูุซ ูุง ูููู ูุฃู ุดุฎุต ุงูุชุณุฌูู) ูุงููุฑููุฉ (ุญูุซ ูููู ุงููุณุชุฎุฏู ุจุชูุนูู ุญุณุงุจู ุจููุณู).

```mermaid
graph TD
    A[ุงููุฑุญูุฉ 0: ุงูุฅุถุงูุฉ ุงููุณุจูุฉ] --> B(ุงููุฑุญูุฉ 1: ูุญุงููุฉ ุชุณุฌูู ุงูุฏุฎูู);
    B --> C{ุญุณุงุจ ุบูุฑ ููุนูุ};
    C -- ูุนู --> D[ุงููุฑุญูุฉ 2: ุจุฏุก ุนูููุฉ ุงูุชูุนูู];
    C -- ูุง --> E[ุชุณุฌูู ุฏุฎูู ูุงุฌุญ];
    D --> F(1. ุงูุชุญูู ูู ุงููููุฉ);
    F --> G{ุจูุงูุงุช ุตุญูุญุฉุ};
    G -- ูุนู --> H(2. ุฅุฏุฎุงู ุงูุจุฑูุฏ ูุฅุฑุณุงู OTP);
    H --> I(3. ุงูุชุญูู ูู OTP);
    I --> J{ุงูุฑูุฒ ุตุญูุญุ};
    J -- ูุนู --> K(4. ุชุนููู ูููุฉ ุงููุฑูุฑ);
    K --> L[ุชุญุฏูุซ ุญุงูุฉ ุงูุญุณุงุจ ุฅูู 'active'];
    L --> M(ุงููุฑุญูุฉ 3: ุชุณุฌูู ุงูุฏุฎูู ูุงูุชูุฌูู);
    M --> N{ูุฑุงุกุฉ ุงูุฏูุฑ};
    N --> O[ุชูุฌูู ุฅูู ููุญุฉ ุงูุชุญูู ุงูููุงุณุจุฉ];
```

---

## 2. ุชูุงุตูู ุงููุฑุงุญู

### ุงููุฑุญูุฉ 0: ุงูุฅุถุงูุฉ ุงููุณุจูุฉ (ูููู ุจูุง ูุณุคูู ุงููุธุงู)

1.  **ุงูุฅุฌุฑุงุก:** ูููู ูุณุคูู ุงููุธุงู ุจุฅุถุงูุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู (ุงูุทูุงุจ ูุงููุฏุฑุณูู) ุฅูู ุฌุฏูู `Users` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ุฅูุง ูุฏููุงู ุนุจุฑ ููุญุฉ ุงูุชุญูู ุฃู ุนุจุฑ ุงุณุชูุฑุงุฏ ุฏูุนุฉ ูุงุญุฏุฉ (Batch Import).
2.  **ุงูุจูุงูุงุช ุงููุฏุฎูุฉ:**
    *   `academic_id` (ุฅูุฒุงูู)
    *   `full_name` (ุฅูุฒุงูู)
    *   `id_card_number` (ุฅูุฒุงููุ ููุชุญูู ูู ุงููููุฉ)
    *   `role_id` (ุฅูุฒุงูู)
    *   `major_id` (ุฅูุฒุงูู ููุทูุงุจ)
    *   `level_id` (ุฅูุฒุงูู ููุทูุงุจ)
3.  **ุงูุญุงูุฉ ุงูุฃูููุฉ:**
    *   `account_status` ูุชู ุชุนูููู ุฅูู `inactive`.
    *   ุญููู `email` ู `password_hash` ููููุงู `NULL`.

### ุงููุฑุญูุฉ 1: ูุญุงููุฉ ุชุณุฌูู ุงูุฏุฎูู ุงูุฃูู

1.  **ุงูุฅุฌุฑุงุก:** ุงููุณุชุฎุฏู ุงูุฐู ุชู ุฅุถุงูุชู ูุณุจูุงู ูุญุงูู ุชุณุฌูู ุงูุฏุฎูู ูุฃูู ูุฑุฉ ุจุงุณุชุฎุฏุงู ุฑููู ุงูุฃูุงุฏููู/ุงููุธููู ูุฃู ูููุฉ ูุฑูุฑ.
2.  **ููุทู ุงููุธุงู (Backend):**
    *   ุงูุจุญุซ ุนู `academic_id` ูู ุฌุฏูู `Users`.
    *   ุฅุฐุง ุชู ุงูุนุซูุฑ ุนูู ุงููุณุชุฎุฏูุ ูุชู ุงูุชุญูู ูู ุญูู `account_status`.
    *   ุจูุง ุฃู ุงูุญุงูุฉ ูู `inactive`ุ ูููุน ุงููุธุงู ุนูููุฉ ุชุณุฌูู ุงูุฏุฎูู.
3.  **ูุงุฌูุฉ ุงููุณุชุฎุฏู (Frontend):**
    *   ูุชู ุนุฑุถ ุฑุณุงูุฉ ูุงุถุญุฉ: "ุญุณุงุจู ููุฌูุฏ ููููู ุบูุฑ ููุนูู. ูุฑุฌู ุงูุถุบุท ุนูู 'ุฅูุดุงุก ุญุณุงุจ' ูุจุฏุก ุนูููุฉ ุงูุชูุนูู."

### ุงููุฑุญูุฉ 2: ุนูููุฉ ุงูุชูุนูู ุงูุฐุงุชู (Self-Activation)

ูุฐู ุงูุนูููุฉ ุชูุฑ ุนุจุฑ ุนุฏุฉ ุดุงุดุงุช ูุชุณูุณูุฉ ูุถูุงู ุงูุฃูุงู.

#### ุงูุฎุทูุฉ 2.1: ุงูุชุญูู ูู ุงููููุฉ

1.  **ุงูุฅุฌุฑุงุก:** ุงููุณุชุฎุฏู ูููุฃ ูููุฐุฌ "ุงูุชุญูู ูู ุงููููุฉ".
2.  **ุงูุจูุงูุงุช ุงููุทููุจุฉ:**
    *   ุงูุฑูู ุงูุฃูุงุฏููู/ุงููุธููู (`academic_id`)
    *   ุฑูู ุงูุจุทุงูุฉ (`id_card_number`)
3.  **ููุทู ุงููุธุงู:**
    *   ูุชู ุงูุจุญุซ ูู ุฌุฏูู `Users` ุนู ุณุฌู ูุทุงุจู **ููุงู ูู** `academic_id` ู `id_card_number`.
    *   **ูู ุญุงูุฉ ุงููุฌุงุญ:** ููุชูู ุงููุณุชุฎุฏู ุฅูู ุงูุฎุทูุฉ ุงูุชุงููุฉ.
    *   **ูู ุญุงูุฉ ุงููุดู:** ุชุนุฑุถ ุงููุงุฌูุฉ ุฑุณุงูุฉ ุฎุทุฃ: "ุงูุจูุงูุงุช ุงููุฏุฎูุฉ ุบูุฑ ุตุญูุญุฉ. ูุฑุฌู ูุฑุงุฌุนุฉ ูุณู ุดุคูู ุงูุทูุงุจ/ุงูููุธููู."

#### ุงูุฎุทูุฉ 2.2: ุฅุฏุฎุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุชูููุฏ OTP

1.  **ุงูุฅุฌุฑุงุก:** ููุทูุจ ูู ุงููุณุชุฎุฏู ุฅุฏุฎุงู ุจุฑูุฏู ุงูุฅููุชุฑููู.
2.  **ููุทู ุงููุธุงู:**
    *   ูุชู ุงูุชุญูู ูู ุฃู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงููุฏุฎู ุบูุฑ ูุณุชุฎุฏู ูู ุฃู ุญุณุงุจ ุขุฎุฑ (`UNIQUE` constraint).
    *   ูุชู ุชูููุฏ ุฑูุฒ ุชุญูู ูุฑูุฏ (OTP) ูููู ูู 6 ุฃุฑูุงู.
    *   ูุชู ุชุฎุฒูู ุงูุฑูุฒ ูู ุฌุฏูู `Verification_Codes` ูุน `user_id` ูููุช ุงูุชูุงุก ุงูุตูุงุญูุฉ (e.g., 10 ุฏูุงุฆู).
    *   ูุชู ุฅุฑุณุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงูุฐู ูุญุชูู ุนูู ุงูุฑูุฒ ุฅูู ุงููุณุชุฎุฏู.

#### ุงูุฎุทูุฉ 2.3: ุงูุชุญูู ูู OTP ูุชุนููู ูููุฉ ุงููุฑูุฑ

1.  **ุงูุฅุฌุฑุงุก:** ููุทูุจ ูู ุงููุณุชุฎุฏู ุฅุฏุฎุงู ุฑูุฒ OTP ุงูุฐู ูุตูู ุนุจุฑ ุงูุจุฑูุฏุ ุซู ุชุนููู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ.
2.  **ููุทู ุงููุธุงู:**
    *   ุงูุชุญูู ูู ุตุญุฉ ุงูุฑูุฒ `OTP` ููู ุฃูู ูู ุชูุชูู ุตูุงุญูุชู.
    *   ุงูุชุญูู ูู ุฃู ูููุฉ ุงููุฑูุฑ ูุชุฃููุฏูุง ูุชุทุงุจูุงู ูุชุชูุงูู ูุน ุณูุงุณุฉ ูููุงุช ุงููุฑูุฑ (e.g., 8 ุฃุญุฑู ุนูู ุงูุฃูู).
3.  **ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช (Transaction):** ุนูุฏ ูุฌุงุญ ุงูุชุญููุ ูุชู ุชูููุฐ ุงูุนูููุงุช ุงูุชุงููุฉ ูู Transaction ูุงุญุฏุฉ ูุถูุงู ุณูุงูุฉ ุงูุจูุงูุงุช:
    *   **ุชุญุฏูุซ ุฌุฏูู `Users`:**
        *   ุชุญุฏูุซ ุญูู `email` ุจุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงูุฌุฏูุฏ.
        *   ุชุดููุฑ (Hash) ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ูุชุฎุฒูููุง ูู ุญูู `password_hash`.
        *   ุชุบููุฑ ุญุงูุฉ ุงูุญุณุงุจ `account_status` ูู `inactive` ุฅูู `active`.
    *   **ุญุฐู ูู ุฌุฏูู `Verification_Codes`:** ูุชู ุญุฐู ุงูุฑูุฒ ุงูุฐู ุชู ุงุณุชุฎุฏุงูู ูููุน ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงูู.

### ุงููุฑุญูุฉ 3: ุชุณุฌูู ุงูุฏุฎูู ูุงูุชูุฌูู

1.  **ุงูุฅุฌุฑุงุก:** ุจุนุฏ ูุฌุงุญ ุนูููุฉ ุงูุชูุนููุ ูุชู ุฅุนุงุฏุฉ ุชูุฌูู ุงููุณุชุฎุฏู ุฅูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู ูุน ุฑุณุงูุฉ ูุฌุงุญ: "ุชู ุชูุนูู ุญุณุงุจู ุจูุฌุงุญ. ููููู ุงูุขู ุชุณุฌูู ุงูุฏุฎูู."
2.  **ุชุณุฌูู ุงูุฏุฎูู:** ูููู ุงููุณุชุฎุฏู ุจุฅุฏุฎุงู ุฑููู ุงูุฃูุงุฏููู/ุงููุธููู ููููุฉ ุงููุฑูุฑ ุงูุชู ูุงู ุจุชุนููููุง ููุชู.
3.  **ููุทู ุงูุชูุฌูู (Role-Based Routing):**
    *   ุจุนุฏ ุงูุชุญูู ูู ุตุญุฉ ุจูุงูุงุช ุงูุฏุฎููุ ููุฑุฃ ุงููุธุงู ูููุฉ `role_id` ูููุณุชุฎุฏู.
    *   ุจูุงุกู ุนูู ูููุฉ ุงูุฏูุฑุ ูุชู ุชูุฌูู ุงููุณุชุฎุฏู ุฅูู ููุญุฉ ุงูุชุญูู ุงููุฎุตุตุฉ ูู:
        *   `role_id = 1` โก๏ธ `/admin/dashboard`
        *   `role_id = 2` โก๏ธ `/instructor/dashboard`
        *   `role_id = 3` โก๏ธ `/student/dashboard`

---

## 3. ููุงุญุธุงุช ุฃูููุฉ

*   ูุฌุจ ุงุณุชุฎุฏุงู HTTPS ูู ุฌููุน ุงูุงุชุตุงูุงุช.
*   ูุฌุจ ุชุดููุฑ ูููุงุช ุงููุฑูุฑ ุจุงุณุชุฎุฏุงู ุฎูุงุฑุฒููุฉ ูููุฉ (e.g., Argon2, bcrypt).
*   ูุฌุจ ูุฑุถ ุญุฏ ุฃูุตู ูุนุฏุฏ ูุญุงููุงุช ุฅุฏุฎุงู OTP ุงููุงุดูุฉ (e.g., 5 ูุญุงููุงุช) ูููุน ูุฌูุงุช ุงูุชุฎููู (Brute-force).


---

## 4. ุงูุฅุฏุงุฑุฉ ุงููุฌูุนุฉ ูููุณุชุฎุฏููู (Bulk User Management)

ูุชุณููู ุฅุฏุงุฑุฉ ุนุฏุฏ ูุจูุฑ ูู ุงููุณุชุฎุฏูููุ ุณูุชู ุชุฒููุฏ ููุญุฉ ุชุญูู ุงููุณุคูู ุจููุฒุงุช ุงูุงุณุชูุฑุงุฏ ูุงูุชุตุฏูุฑ ุงููุฌูุนุฉ.

### 4.1. ุงุณุชูุฑุงุฏ ุงููุณุชุฎุฏููู (Import Users)

*   **ุงููุธููุฉ:** ูููู ูููุณุคูู ุฑูุน ููู ุจุตูุบุฉ `CSV` ุฃู `Excel` ูุญุชูู ุนูู ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงูุฌุฏุฏ.
*   **ุชูุณูู ุงูููู:** ูุฌุจ ุฃู ูุญุชูู ุงูููู ุนูู ุงูุฃุนูุฏุฉ ุงูุชุงููุฉ ุจุงูุชุฑุชูุจ:
    *   `academic_id`
    *   `full_name`
    *   `id_card_number`
    *   `role` (ุงูููู ุงููุตูุฉ: `Admin`, `Instructor`, `Student`)
    *   `major` (ุงูุงุณู ุงููุตู ููุชุฎุตุต)
    *   `level` (ุงูุงุณู ุงููุตู ูููุณุชูู)
*   **ููุทู ุงููุธุงู:**
    1.  ูููู ุงููุธุงู ุจูุฑุงุกุฉ ุงูููู ูุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ูู ูู ุตู (e.g., ูู ุงูุฏูุฑ ููุฌูุฏุ ูู ุงูุชุฎุตุต ููุฌูุฏุ).
    2.  ููู ุตู ุตุญูุญุ ูููู ุงููุธุงู ุจุฅูุดุงุก ุณุฌู ุฌุฏูุฏ ูู ุฌุฏูู `Users` ูุน `account_status = 'inactive'`.
    3.  ูู ููุงูุฉ ุงูุนูููุฉุ ูุนุฑุถ ุงููุธุงู ุชูุฑูุฑุงู ูููุณุคูู ููุถุญ ุนุฏุฏ ุงูุณุฌูุงุช ุงูุชู ุชู ุงุณุชูุฑุงุฏูุง ุจูุฌุงุญ ูุฃู ุฃุฎุทุงุก ุญุฏุซุช ูู ุตููู ูุนููุฉ.

### 4.2. ุชุตุฏูุฑ ุงููุณุชุฎุฏููู (Export Users)

*   **ุงููุธููุฉ:** ูููู ูููุณุคูู ุงูุถุบุท ุนูู ุฒุฑ "ุชุตุฏูุฑ ุงููุณุชุฎุฏููู" ูู ุฃู ููุช.
*   **ููุทู ุงููุธุงู:** ูููู ุงููุธุงู ุจุฅูุดุงุก ูุชูุฒูู ููู `CSV` ูุญุชูู ุนูู ุฌููุน ุจูุงูุงุช ุงููุณุชุฎุฏููู ุงููุณุฌููู ูู ุฌุฏูู `Users` (ุจุงุณุชุซูุงุก `password_hash`).
